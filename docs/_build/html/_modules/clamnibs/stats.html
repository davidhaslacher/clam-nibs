<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>clamnibs.stats &#8212; CLAM-NIBS  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for clamnibs.stats</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mne.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_cluster_test</span><span class="p">,</span> <span class="n">permutation_cluster_1samp_test</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">coo_matrix</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mne.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">ttest_ind_no_p</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mne.viz.topomap</span><span class="w"> </span><span class="kn">import</span> <span class="n">_get_pos_outlines</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mne.utils.check</span><span class="w"> </span><span class="kn">import</span> <span class="n">_check_sphere</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mne</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mne.viz</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_topomap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">ttest_ind</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_test</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fooof</span><span class="w"> </span><span class="kn">import</span> <span class="n">FOOOF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fooof.analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_band_peak_fm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">_fmt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.misc</span><span class="w"> </span><span class="kn">import</span> <span class="n">df_to_array</span>

<span class="c1"># TODO:</span>
<span class="c1"># Statistics over sessions in session_wise studies</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_dft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">plot_sine</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phases</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="n">n_bins</span>
    <span class="n">amp</span><span class="p">,</span> <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_sine</span><span class="p">:</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">phases_xs</span> <span class="o">=</span> <span class="n">xs</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">n_bins</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">phases_xs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phases_xs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">amp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phases</span> <span class="o">+</span> <span class="n">phase</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">amp</span><span class="p">,</span> <span class="n">_wrap</span><span class="p">(</span><span class="o">-</span><span class="n">phase</span><span class="p">)</span>

<span class="c1"># Each arg in args should be of shape (n_samples, n_features)</span>
<span class="c1"># This function averages over n_samples and computes DFT amplitude for each feature </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_vectorized_dft_amp</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
    <span class="c1"># Compute mean across samples for each feature</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
    <span class="c1"># Use parallel processing to compute DFT amplitudes</span>
    <span class="n">amps</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">_dft</span><span class="p">)(</span><span class="n">means</span><span class="p">[:,</span> <span class="n">ix_feature</span><span class="p">])</span> <span class="k">for</span> <span class="n">ix_feature</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="c1"># Extract amplitude from the result</span>
    <span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">amp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">amp</span> <span class="ow">in</span> <span class="n">amps</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">amps</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_dft_amp_stat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_vectorized_dft_amp</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># This is a hacky solution to make permutation_cluster_test compatible with the SINE FIT BINNED procedure outlined in [1].</span>
<span class="c1"># Unfortunately, permutation_cluster_test can&#39;t handle trial-level data for multiple participants.</span>
<span class="c1"># Therefore, args are ignored and orig_args are used here.</span>
<span class="c1"># This function permutes trials across phase bins within each participant.</span>
<span class="c1"># Trials are averaged within each phase bin and the DFT amplitude is computed for each participant.</span>
<span class="c1"># The group-level test statistic is then the DFT amplitude averaged over participants.</span>
<span class="c1"># [1] Zoefel, Benedikt, et al. &quot;How to test for phasic modulation of neural and behavioural responses.&quot; Neuroimage 202 (2019): 116175.</span>
<span class="c1"># orig_args is a list of arrays, one per participant i, each of shape (n_phases, n_epochs_i, n_conns)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_dft_amp_stat_group</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">orig_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">first_pass_done</span>
    <span class="c1"># Shuffle if original test statistic was computed (first pass done)</span>
    <span class="k">if</span> <span class="n">first_pass_done</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ix_arg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_args</span><span class="p">)):</span>
            <span class="n">n_phases</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="n">ix_arg</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">n_epochs</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="n">ix_arg</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ix0</span><span class="p">,</span> <span class="n">ix1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n_phases</span> <span class="o">*</span> <span class="n">n_epochs</span><span class="p">),</span>
                                                              <span class="p">(</span><span class="n">n_phases</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">))</span>
            <span class="n">orig_args</span><span class="p">[</span><span class="n">ix_arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="n">ix_arg</span><span class="p">][</span><span class="n">ix0</span><span class="p">,</span> <span class="n">ix1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">orig_args</span><span class="p">[</span><span class="n">ix_arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="n">ix_arg</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_phases</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">first_pass_done</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">all_dft_amps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">orig_arg</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="p">:</span>
        <span class="n">dft_amps</span> <span class="o">=</span> <span class="n">_vectorized_dft_amp</span><span class="p">(</span><span class="o">*</span><span class="n">orig_arg</span><span class="p">)</span>
        <span class="n">all_dft_amps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dft_amps</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_dft_amps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_wrap</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phases</span><span class="p">))</span>

<div class="viewcode-block" id="test_sensor_network_modulation">
<a class="viewcode-back" href="../../clamnibs.html#clamnibs.stats.test_sensor_network_modulation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_sensor_network_modulation</span><span class="p">(</span>
        <span class="n">df_data</span><span class="p">,</span>
        <span class="n">info</span><span class="p">,</span>
        <span class="n">test_level</span><span class="o">=</span><span class="s1">&#39;participant&#39;</span><span class="p">,</span>
        <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;phase_lag_index&#39;</span><span class="p">,</span>
        <span class="n">threshold_percentile</span><span class="o">=</span><span class="mi">95</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test phase-dependent modulation of functional connectivity at the sensor level.</span>

<span class="sd">    This function performs a network-based permutation test to identify networks whose</span>
<span class="sd">    connectivity is modulated by CLAM-NIBS, and plots the results.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df_data : pandas.DataFrame</span>
<span class="sd">        The DataFrame containing connectivity matrices per participant, or per epoch</span>
<span class="sd">        for each participant.</span>
<span class="sd">    </span>
<span class="sd">    info : mne.Info</span>
<span class="sd">        The Info object for topographic plotting.</span>
<span class="sd">        </span>
<span class="sd">    test_level : str, optional (default=&#39;participant&#39;)</span>
<span class="sd">        The level at which the test should be performed (&#39;participant&#39; or &#39;group&#39;).</span>
<span class="sd">        </span>
<span class="sd">    measure : str, optional (default=&#39;phase_lag_index&#39;)</span>
<span class="sd">        The connectivity measure employed.</span>
<span class="sd">        </span>
<span class="sd">    plot : str or bool, optional (default=False)</span>
<span class="sd">        If string, the plot(s) will be saved at that path.</span>
<span class="sd">        If True, a figure will be created but not shown or saved.</span>
<span class="sd">        If False, no figure will be created.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">    Exception:</span>
<span class="sd">        If the test level is not \&#39;participant\&#39; or \&#39;group\&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">measure</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">test_level</span> <span class="o">==</span> <span class="s1">&#39;participant&#39;</span><span class="p">:</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">_test_sensor_network_modulation_participant</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> 
                                                                 <span class="n">info</span><span class="p">,</span> 
                                                                 <span class="n">measure</span><span class="p">,</span>
                                                                 <span class="n">threshold_percentile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_results</span>
    <span class="k">elif</span> <span class="n">test_level</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">_test_sensor_network_modulation_group</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> 
                                                           <span class="n">info</span><span class="p">,</span> 
                                                           <span class="n">measure</span><span class="p">,</span> 
                                                           <span class="n">threshold_percentile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_results</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s1">&#39;Test level should be either </span><span class="se">\&#39;</span><span class="s1">participant</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">group</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_test_sensor_network_modulation_participant</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">threshold_percentile</span><span class="p">):</span>
    <span class="n">gb_participant</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;participant&#39;</span><span class="p">)</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">participant</span><span class="p">,</span> <span class="n">df_participant</span> <span class="ow">in</span> <span class="n">gb_participant</span><span class="p">:</span>
        <span class="n">gb_target_phases</span> <span class="o">=</span> <span class="n">df_participant</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="s1">&#39;target_phase&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;target_phase&#39;</span><span class="p">)</span>
        <span class="n">target_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target_phase</span><span class="p">,</span> <span class="n">df_target_phase</span> <span class="ow">in</span> <span class="n">gb_target_phases</span><span class="p">:</span>
            <span class="n">target_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_phase</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df_target_phase</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_chs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n_conns</span> <span class="o">=</span> <span class="n">n_chs</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_conns</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">adjacency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_conns</span><span class="p">,</span> <span class="n">n_conns</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ix_conn_1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_conns</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ix_conn_2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ix_conn_1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_conns</span><span class="p">):</span>
                <span class="n">ix_ch_1</span> <span class="o">=</span> <span class="n">ix_conn_1</span> <span class="o">//</span> <span class="n">n_chs</span>
                <span class="n">ix_ch_2</span> <span class="o">=</span> <span class="n">ix_conn_1</span> <span class="o">%</span> <span class="n">n_chs</span>
                <span class="n">ix_ch_3</span> <span class="o">=</span> <span class="n">ix_conn_2</span> <span class="o">//</span> <span class="n">n_chs</span>
                <span class="n">ix_ch_4</span> <span class="o">=</span> <span class="n">ix_conn_2</span> <span class="o">%</span> <span class="n">n_chs</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">{</span><span class="n">ix_ch_1</span><span class="p">,</span> <span class="n">ix_ch_2</span><span class="p">}</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">({</span><span class="n">ix_ch_3</span><span class="p">,</span> <span class="n">ix_ch_4</span><span class="p">}):</span>
                    <span class="n">adjacency</span><span class="p">[</span><span class="n">ix_conn_1</span><span class="p">,</span> <span class="n">ix_conn_2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">adjacency</span> <span class="o">+=</span> <span class="n">adjacency</span><span class="o">.</span><span class="n">T</span>
        <span class="n">adjacency</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span><span class="n">adjacency</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># use t-statistic</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">n_obs</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">tvals</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">permutation_cluster_test</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                                                 <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                                                                 <span class="n">adjacency</span><span class="o">=</span><span class="n">adjacency</span><span class="p">,</span>
                                                                 <span class="n">out_type</span><span class="o">=</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span>
                                                                 <span class="n">step_down_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                 <span class="n">t_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                 <span class="n">stat_fun</span><span class="o">=</span><span class="n">ttest_ind_no_p</span><span class="p">,</span>
                                                                 <span class="n">tail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                 <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                 <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tvals_unit</span> <span class="o">=</span> <span class="s1">&#39;ttest_ind&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat_fun</span> <span class="o">=</span> <span class="n">_dft_amp_stat</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span>
                <span class="p">[</span><span class="n">stat_fun</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">d</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_conns</span><span class="p">)],</span> <span class="n">threshold_percentile</span><span class="p">)</span>
            <span class="n">tvals</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">permutation_cluster_test</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                                                 <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                                                                 <span class="n">adjacency</span><span class="o">=</span><span class="n">adjacency</span><span class="p">,</span>
                                                                 <span class="n">out_type</span><span class="o">=</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span>
                                                                 <span class="n">step_down_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                 <span class="n">t_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                 <span class="n">stat_fun</span><span class="o">=</span><span class="n">stat_fun</span><span class="p">,</span>
                                                                 <span class="n">tail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                 <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                 <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tvals_unit</span> <span class="o">=</span> <span class="s1">&#39;dft_amp&#39;</span>
        <span class="n">tvals_sig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pvals_sig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">conns_sig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ix_cluster</span><span class="p">,</span> <span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">pval</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">pval</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="n">tvals_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvals</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
                <span class="n">pvals_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
                <span class="n">conns_cluster</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ix_conn</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">ix_ch_1</span> <span class="o">=</span> <span class="n">ix_conn</span> <span class="o">//</span> <span class="n">n_chs</span>
                    <span class="n">ix_ch_2</span> <span class="o">=</span> <span class="n">ix_conn</span> <span class="o">%</span> <span class="n">n_chs</span>
                    <span class="n">conns_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ix_ch_1</span><span class="p">,</span> <span class="n">ix_ch_2</span><span class="p">])</span>
                <span class="n">conns_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conns_cluster</span><span class="p">)</span>
        <span class="n">df_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;participant&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">participant</span><span class="p">]</span> <span class="o">*</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tvals_sig</span><span class="p">),</span>
                <span class="s1">&#39;t_unit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tvals_unit</span><span class="p">]</span> <span class="o">*</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tvals_sig</span><span class="p">),</span>
                <span class="s1">&#39;t_values&#39;</span><span class="p">:</span> <span class="n">tvals_sig</span><span class="p">,</span>
                <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">pvals_sig</span><span class="p">,</span>
                <span class="s1">&#39;connections&#39;</span><span class="p">:</span> <span class="n">conns_sig</span><span class="p">})</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_results</span><span class="p">,</span> <span class="n">df_append</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_results</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_test_sensor_network_modulation_group</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">threshold_percentile</span><span class="p">):</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gb_participants</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;participant&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">participant</span><span class="p">,</span> <span class="n">df_participant</span> <span class="ow">in</span> <span class="n">gb_participants</span><span class="p">:</span>
        <span class="n">gb_target_phases</span> <span class="o">=</span> <span class="n">df_participant</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="s1">&#39;target_phase&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;target_phase&#39;</span><span class="p">)</span>
        <span class="n">target_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target_phase</span><span class="p">,</span> <span class="n">df_target_phase</span> <span class="ow">in</span> <span class="n">gb_target_phases</span><span class="p">:</span>
            <span class="n">target_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_phase</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df_target_phase</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="n">n_epochs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="p">[:</span><span class="n">n_epochs</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="c1"># data is now (n_phases, n_epochs, n_chs, n_chs)</span>
        <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">n_participants</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span>
    <span class="n">n_phases</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_chs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_conns</span> <span class="o">=</span> <span class="n">n_chs</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_phases</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_conns</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_data</span><span class="p">]</span>
    <span class="c1"># each data in all_data is now (n_phases, n_epochs, n_conns)</span>
    <span class="n">adjacency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_conns</span><span class="p">,</span> <span class="n">n_conns</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ix_conn_1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_conns</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ix_conn_2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ix_conn_1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_conns</span><span class="p">):</span>
            <span class="n">ix_ch_1</span> <span class="o">=</span> <span class="n">ix_conn_1</span> <span class="o">//</span> <span class="n">n_chs</span>
            <span class="n">ix_ch_2</span> <span class="o">=</span> <span class="n">ix_conn_1</span> <span class="o">%</span> <span class="n">n_chs</span>
            <span class="n">ix_ch_3</span> <span class="o">=</span> <span class="n">ix_conn_2</span> <span class="o">//</span> <span class="n">n_chs</span>
            <span class="n">ix_ch_4</span> <span class="o">=</span> <span class="n">ix_conn_2</span> <span class="o">%</span> <span class="n">n_chs</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">{</span><span class="n">ix_ch_1</span><span class="p">,</span> <span class="n">ix_ch_2</span><span class="p">}</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">({</span><span class="n">ix_ch_3</span><span class="p">,</span> <span class="n">ix_ch_4</span><span class="p">}):</span>
                <span class="n">adjacency</span><span class="p">[</span><span class="n">ix_conn_1</span><span class="p">,</span> <span class="n">ix_conn_2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">adjacency</span> <span class="o">+=</span> <span class="n">adjacency</span><span class="o">.</span><span class="n">T</span>
    <span class="n">adjacency</span> <span class="o">=</span> <span class="n">coo_matrix</span><span class="p">(</span><span class="n">adjacency</span><span class="p">)</span>
    <span class="c1"># Unfortunately, permutation_cluster_test can&#39;t handle single-trial data for multiple participants.</span>
    <span class="c1"># Therefore, we will pass dummy data of the expected shape here and implement the permutation and </span>
    <span class="c1"># test statistic computation in _dft_amp_stat_group. See _dft_amp_stat_group for more information.</span>
    <span class="k">global</span> <span class="n">first_pass_done</span>
    <span class="n">first_pass_done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">stat_fun</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">_dft_amp_stat_group</span><span class="p">,</span>
        <span class="n">orig_args</span><span class="o">=</span><span class="n">all_data</span><span class="p">)</span>
    <span class="n">dummy_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_participants</span><span class="p">,</span> <span class="n">n_conns</span><span class="p">))</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_phases</span><span class="p">)]</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">stat_fun</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">),</span> <span class="n">threshold_percentile</span><span class="p">)</span>
    <span class="c1"># Hacky, have to set this to false again, because it is used in permutation_cluster_test</span>
    <span class="n">first_pass_done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tvals</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">permutation_cluster_test</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">,</span>
                                                            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                                                            <span class="n">n_permutations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                                            <span class="n">adjacency</span><span class="o">=</span><span class="n">adjacency</span><span class="p">,</span>
                                                            <span class="n">out_type</span><span class="o">=</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span>
                                                            <span class="n">step_down_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">t_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">stat_fun</span><span class="o">=</span><span class="n">stat_fun</span><span class="p">,</span>
                                                            <span class="n">tail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">buffer_size</span><span class="o">=</span><span class="n">n_conns</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">{:d}</span><span class="s1"> clusters&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p-values: &#39;</span><span class="p">,</span> <span class="n">pvals</span><span class="p">)</span>
    <span class="n">tvals_unit</span> <span class="o">=</span> <span class="s1">&#39;dft_amp&#39;</span>
    <span class="n">tvals_sig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pvals_sig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">conns_sig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ix_cluster</span><span class="p">,</span> <span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">pval</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">pval</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">tvals_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvals</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
            <span class="n">pvals_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
            <span class="n">conns_cluster</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ix_conn</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">ix_ch_1</span> <span class="o">=</span> <span class="n">ix_conn</span> <span class="o">//</span> <span class="n">n_chs</span>
                <span class="n">ix_ch_2</span> <span class="o">=</span> <span class="n">ix_conn</span> <span class="o">%</span> <span class="n">n_chs</span>
                <span class="n">conns_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ix_ch_1</span><span class="p">,</span> <span class="n">ix_ch_2</span><span class="p">])</span>
            <span class="n">conns_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conns_cluster</span><span class="p">)</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;participant&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvals_sig</span><span class="p">),</span>
                              <span class="s1">&#39;t_unit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tvals_unit</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvals_sig</span><span class="p">),</span>
                              <span class="s1">&#39;t_values&#39;</span><span class="p">:</span> <span class="n">tvals_sig</span><span class="p">,</span>
                              <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">pvals_sig</span><span class="p">,</span>
                              <span class="s1">&#39;connections&#39;</span><span class="p">:</span> <span class="n">conns_sig</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">df_results</span>


<div class="viewcode-block" id="test_sensor_cluster_modulation">
<a class="viewcode-back" href="../../clamnibs.html#clamnibs.stats.test_sensor_cluster_modulation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_sensor_cluster_modulation</span><span class="p">(</span>
        <span class="n">df_data</span><span class="p">,</span>
        <span class="n">info</span><span class="p">,</span>
        <span class="n">test_level</span><span class="o">=</span><span class="s1">&#39;participant&#39;</span><span class="p">,</span>
        <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span>
        <span class="n">threshold_percentile</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test phase-dependent modulation of arbitrary outcome measure (e.g. power) at the sensor level.</span>

<span class="sd">    This function performs a cluster-based permutation test to identify clusters of sensors whose</span>
<span class="sd">    value of the outcome measure is modulated by CLAM-NIBS, and plots the results.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df_data : pandas.DataFrame</span>
<span class="sd">        The DataFrame containing outcome measure (for all sensors) per participant, or per epoch</span>
<span class="sd">        for each participant.</span>
<span class="sd">    </span>
<span class="sd">    info : mne.Info</span>
<span class="sd">        The Info object for topographic plotting.</span>
<span class="sd">        </span>
<span class="sd">    test_level : str, optional (default=&#39;participant&#39;)</span>
<span class="sd">        The level at which the test should be performed (&#39;participant&#39; or &#39;group&#39;).</span>
<span class="sd">        </span>
<span class="sd">    measure : str, optional (default=&#39;amplitude&#39;)</span>
<span class="sd">        The outcome measure employed.</span>
<span class="sd">        </span>
<span class="sd">    plot : str or bool, optional (default=False)</span>
<span class="sd">        If string, the plot(s) will be saved at that path.</span>
<span class="sd">        If True, a figure will be created but not shown or saved.</span>
<span class="sd">        If False, no figure will be created.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">    Exception:</span>
<span class="sd">        If the test level is not \&#39;participant\&#39; or \&#39;group\&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">measure</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">test_level</span> <span class="o">==</span> <span class="s1">&#39;participant&#39;</span><span class="p">:</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">_test_sensor_cluster_modulation_participant</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> 
                                                                 <span class="n">info</span><span class="p">,</span> 
                                                                 <span class="n">measure</span><span class="p">,</span>
                                                                 <span class="n">threshold_percentile</span><span class="p">,</span> 
                                                                 <span class="n">plot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_results</span>
    <span class="k">elif</span> <span class="n">test_level</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">_test_sensor_cluster_modulation_group</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> 
                                                           <span class="n">info</span><span class="p">,</span> 
                                                           <span class="n">measure</span><span class="p">,</span> 
                                                           <span class="n">threshold_percentile</span><span class="p">,</span>
                                                           <span class="n">plot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_results</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s1">&#39;Test level should be either </span><span class="se">\&#39;</span><span class="s1">participant</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">group</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_test_sensor_cluster_modulation_participant</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">threshold_percentile</span><span class="p">,</span> <span class="n">plot</span><span class="p">):</span>
    <span class="n">gb_participant</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;participant&#39;</span><span class="p">)</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">participant</span><span class="p">,</span> <span class="n">df_participant</span> <span class="ow">in</span> <span class="n">gb_participant</span><span class="p">:</span>
        <span class="n">gb_target_phases</span> <span class="o">=</span> <span class="n">df_participant</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="s1">&#39;target_phase&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;target_phase&#39;</span><span class="p">)</span>
        <span class="n">target_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target_phase</span><span class="p">,</span> <span class="n">df_target_phase</span> <span class="ow">in</span> <span class="n">gb_target_phases</span><span class="p">:</span>
            <span class="n">target_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_phase</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df_target_phase</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_chs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">adjacency</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">find_ch_adjacency</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># use t-statistic</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">n_obs</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">tvals</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">permutation_cluster_test</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                                                 <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                                                                 <span class="n">adjacency</span><span class="o">=</span><span class="n">adjacency</span><span class="p">,</span>
                                                                 <span class="n">out_type</span><span class="o">=</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span>
                                                                 <span class="n">step_down_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                 <span class="n">t_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                 <span class="n">stat_fun</span><span class="o">=</span><span class="n">ttest_ind_no_p</span><span class="p">,</span>
                                                                 <span class="n">tail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                 <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                 <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tvals_unit</span> <span class="o">=</span> <span class="s1">&#39;ttest_ind&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat_fun</span> <span class="o">=</span> <span class="n">_dft_amp_stat</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span>
                <span class="p">[</span><span class="n">stat_fun</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">d</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_chs</span><span class="p">)],</span> <span class="n">threshold_percentile</span><span class="p">)</span>
            <span class="n">tvals</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">permutation_cluster_test</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                                                 <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                                                                 <span class="n">adjacency</span><span class="o">=</span><span class="n">adjacency</span><span class="p">,</span>
                                                                 <span class="n">out_type</span><span class="o">=</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span>
                                                                 <span class="n">step_down_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                 <span class="n">t_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                 <span class="n">stat_fun</span><span class="o">=</span><span class="n">stat_fun</span><span class="p">,</span>
                                                                 <span class="n">tail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                 <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                                 <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tvals_unit</span> <span class="o">=</span> <span class="s1">&#39;dft_amp&#39;</span>
        <span class="n">tvals_sig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pvals_sig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">channels_sig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mask_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_chs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix_cluster</span><span class="p">,</span> <span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">pval</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">pval</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
                <span class="n">tvals_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvals</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
                <span class="n">pvals_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
                <span class="n">channels_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">ch_names</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
                <span class="n">mask_sig</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">plot_topomap</span><span class="p">(</span>
                <span class="n">tvals</span><span class="p">,</span>
                <span class="n">info</span><span class="p">,</span>
                <span class="n">sensors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">mask</span><span class="o">=</span><span class="n">mask_sig</span><span class="p">,</span>
                <span class="n">contours</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
                <span class="s1">&#39;Modulation of </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_fmt</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span> <span class="n">_fmt</span><span class="p">(</span><span class="n">tvals_unit</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, Modulation of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">participant</span><span class="p">,</span>
                    <span class="n">_fmt</span><span class="p">(</span><span class="n">measure</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">df_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;participant&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">participant</span><span class="p">]</span> <span class="o">*</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tvals_sig</span><span class="p">),</span>
                <span class="s1">&#39;t_unit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tvals_unit</span><span class="p">]</span> <span class="o">*</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tvals_sig</span><span class="p">),</span>
                <span class="s1">&#39;t_values&#39;</span><span class="p">:</span> <span class="n">tvals_sig</span><span class="p">,</span>
                <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">pvals_sig</span><span class="p">,</span>
                <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="n">channels_sig</span><span class="p">})</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_results</span><span class="p">,</span> <span class="n">df_append</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_results</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_test_sensor_cluster_modulation_group</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">threshold_percentile</span><span class="p">,</span> <span class="n">plot</span><span class="p">):</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gb_participants</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;participant&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">participant</span><span class="p">,</span> <span class="n">df_participant</span> <span class="ow">in</span> <span class="n">gb_participants</span><span class="p">:</span>
        <span class="n">gb_target_phases</span> <span class="o">=</span> <span class="n">df_participant</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="s1">&#39;target_phase&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;target_phase&#39;</span><span class="p">)</span>
        <span class="n">target_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target_phase</span><span class="p">,</span> <span class="n">df_target_phase</span> <span class="ow">in</span> <span class="n">gb_target_phases</span><span class="p">:</span>
            <span class="n">target_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_phase</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">df_target_phase</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="n">n_epochs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="p">[:</span><span class="n">n_epochs</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="c1"># data is now (n_phases, n_epochs, n_chs)</span>
        <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">adjacency</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">find_ch_adjacency</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_participants</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span>
    <span class="n">n_phases</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_chs</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Unfortunately, permutation_cluster_test can&#39;t handle single-trial data for multiple participants.</span>
    <span class="c1"># Therefore, we will pass dummy data of the expected shape here and implement the permutation and </span>
    <span class="c1"># test statistic computation in _dft_amp_stat_group. See _dft_amp_stat_group for more information.</span>
    <span class="k">global</span> <span class="n">first_pass_done</span>
    <span class="n">first_pass_done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">stat_fun</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">_dft_amp_stat_group</span><span class="p">,</span>
        <span class="n">orig_args</span><span class="o">=</span><span class="n">all_data</span><span class="p">)</span>
    <span class="n">dummy_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_participants</span><span class="p">,</span> <span class="n">n_chs</span><span class="p">))</span> <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_phases</span><span class="p">)]</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">stat_fun</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">),</span> <span class="n">threshold_percentile</span><span class="p">)</span>
    <span class="c1"># Hacky, have to set this to false again, because it is used in permutation_cluster_test</span>
    <span class="n">first_pass_done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tvals</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">permutation_cluster_test</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">,</span>
                                                            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                                                            <span class="n">n_permutations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                                            <span class="n">adjacency</span><span class="o">=</span><span class="n">adjacency</span><span class="p">,</span>
                                                            <span class="n">out_type</span><span class="o">=</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span>
                                                            <span class="n">step_down_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">t_power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">stat_fun</span><span class="o">=</span><span class="n">stat_fun</span><span class="p">,</span>
                                                            <span class="n">tail</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">buffer_size</span><span class="o">=</span><span class="n">n_chs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">{:d}</span><span class="s1"> clusters&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p-values: &#39;</span><span class="p">,</span> <span class="n">pvals</span><span class="p">)</span>
    <span class="n">tvals_unit</span> <span class="o">=</span> <span class="s1">&#39;dft_amp&#39;</span>
    <span class="n">tvals_sig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pvals_sig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_sig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mask_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_chs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ix_cluster</span><span class="p">,</span> <span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">pval</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">pvals</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">pval</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">tvals_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvals</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
            <span class="n">pvals_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pval</span><span class="p">)</span>
            <span class="n">channels_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">ch_names</span><span class="p">[</span><span class="n">cluster</span><span class="p">])</span>
            <span class="n">mask_sig</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plot_topomap</span><span class="p">(</span>
            <span class="n">tvals</span><span class="p">,</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">sensors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask_sig</span><span class="p">,</span>
            <span class="n">contours</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
            <span class="s1">&#39;Modulation of </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_fmt</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
                <span class="n">_fmt</span><span class="p">(</span><span class="n">tvals_unit</span><span class="p">)))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Group, Modulation of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_fmt</span><span class="p">(</span><span class="n">measure</span><span class="p">)))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;participant&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvals_sig</span><span class="p">),</span>
                              <span class="s1">&#39;t_unit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tvals_unit</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvals_sig</span><span class="p">),</span>
                              <span class="s1">&#39;t_values&#39;</span><span class="p">:</span> <span class="n">tvals_sig</span><span class="p">,</span>
                              <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">pvals_sig</span><span class="p">,</span>
                              <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="n">channels_sig</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">df_results</span>


<div class="viewcode-block" id="test_modulation">
<a class="viewcode-back" href="../../clamnibs.html#clamnibs.stats.test_modulation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_modulation</span><span class="p">(</span>
        <span class="n">df_data</span><span class="p">,</span>
        <span class="n">test_level</span><span class="o">=</span><span class="s1">&#39;participant&#39;</span><span class="p">,</span>
        <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span>
        <span class="n">agg_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_mode</span><span class="o">=</span><span class="s1">&#39;box_strip&#39;</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test phase-dependent modulation of arbitrary outcome measure (e.g. amplitude).</span>

<span class="sd">    This function performs a permutation test to identify phase-dependent modulation</span>
<span class="sd">    of the outcome measure by CLAM-NIBS, and plots the results.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df_data : pandas.DataFrame</span>
<span class="sd">        The DataFrame containing outcome measure per participant, or per epoch</span>
<span class="sd">        for each participant.</span>
<span class="sd">        </span>
<span class="sd">    test_level : str, optional (default=&#39;participant&#39;)</span>
<span class="sd">        The level at which the test should be performed (&#39;participant&#39; or &#39;group&#39;).</span>
<span class="sd">        </span>
<span class="sd">    measure : str, optional (default=&#39;amplitude&#39;)</span>
<span class="sd">        The outcome measure employed.</span>
<span class="sd">        </span>
<span class="sd">    agg_func : callable, optimal (default=np.nanmean)</span>
<span class="sd">        The function used to aggregate across trials within each phase bin (e.g. np.nanmean or np.nanstd).</span>
<span class="sd">        </span>
<span class="sd">    plot : str or bool, optional (default=False)</span>
<span class="sd">        If string, the plot(s) will be saved at that path.</span>
<span class="sd">        If True, a figure will be created but not shown or saved.</span>
<span class="sd">        If False, no figure will be created.</span>
<span class="sd">        </span>
<span class="sd">    plot_mode : str, optional (default=&#39;box_strip&#39;)</span>
<span class="sd">        The plotting mode. If all data points should be shown, use &#39;box_strip&#39; for a boxplot and stripplot.</span>
<span class="sd">        If data points should only be visualized as aggregated measures (e.g. accuracy across all trials or </span>
<span class="sd">        variability across all ECG RR intervals), use &#39;bar&#39; for a barplot.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">    Exception:</span>
<span class="sd">        If the test level is not \&#39;participant\&#39; or \&#39;group\&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;ol&#39;</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">],</span> <span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;target_phase&#39;</span><span class="p">])):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;test_modulation test for phase-dependent modulation, it currently </span><span class="se">\</span>
<span class="s1">                        does not support open-loop or no stimulation conditions&#39;</span><span class="p">)</span>
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">measure</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">test_level</span> <span class="o">==</span> <span class="s1">&#39;participant&#39;</span><span class="p">:</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">_test_modulation_participant</span><span class="p">(</span><span class="n">df_data</span><span class="o">=</span><span class="n">df_data</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="n">agg_func</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">plot_mode</span><span class="o">=</span><span class="n">plot_mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_results</span>
    <span class="k">elif</span> <span class="n">test_level</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">_test_modulation_group</span><span class="p">(</span><span class="n">df_data</span><span class="o">=</span><span class="n">df_data</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">plot_mode</span><span class="o">=</span><span class="n">plot_mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_results</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s1">&#39;Test level should be either </span><span class="se">\&#39;</span><span class="s1">participant</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">group</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_test_modulation_participant</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">agg_func</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">plot_mode</span><span class="p">):</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">participants</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;participant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">participant</span> <span class="ow">in</span> <span class="n">participants</span><span class="p">:</span>
        <span class="n">df_participant</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;participant&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">participant</span><span class="p">]</span>
        <span class="n">gb_target_phase</span> <span class="o">=</span> <span class="n">df_participant</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;target_phase&#39;</span><span class="p">)</span>
        <span class="n">target_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_measures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target_phase</span><span class="p">,</span> <span class="n">df_target_phase</span> <span class="ow">in</span> <span class="n">gb_target_phase</span><span class="p">:</span>
            <span class="n">target_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_phase</span><span class="p">)</span>
            <span class="n">target_measures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_target_phase</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tval</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">target_measures</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_measures</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tval_unit</span> <span class="o">=</span> <span class="s1">&#39;ttest_ind&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">permutation_test</span><span class="p">(</span><span class="n">target_measures</span><span class="p">,</span>
                                   <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">_dft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">agg_func</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]))[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">permutation_type</span><span class="o">=</span><span class="s1">&#39;independent&#39;</span><span class="p">,</span>
                                   <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">,</span>
                                   <span class="n">n_resamples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">tval</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">statistic</span>
            <span class="n">pval</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">pvalue</span>
            <span class="n">tval_unit</span> <span class="o">=</span> <span class="s1">&#39;dft_amp&#39;</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">target_phases</span><span class="p">[</span><span class="n">ix</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_measures</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">))])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span> <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">target_measures</span><span class="p">)</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">):</span> <span class="n">y</span><span class="p">})</span>
            <span class="n">df_plot_agg</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">)</span> \
                            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">)</span> <span class="p">:</span> <span class="n">agg_func</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">plot_mode</span> <span class="o">==</span> <span class="s1">&#39;box_strip&#39;</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
                    <span class="n">df_plot</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span>
                    <span class="n">df_plot</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_mode</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
                    <span class="n">df_plot_agg</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">errorbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t = </span><span class="si">{:.3e}</span><span class="s1">, p = </span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">pval</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avgs</span> <span class="o">=</span> <span class="n">df_plot_agg</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">)]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">_dft</span><span class="p">(</span><span class="n">avgs</span><span class="p">,</span> <span class="n">plot_sine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;dft_amp = </span><span class="si">{:.3e}</span><span class="s1">, p = </span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">pval</span><span class="p">))</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ps.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;paper&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_modulation_</span><span class="si">{}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">participant</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">df_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;participant&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">participant</span><span class="p">],</span>
                                  <span class="s1">&#39;t_unit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tval_unit</span><span class="p">],</span>
                                  <span class="s1">&#39;t_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tval</span><span class="p">],</span>
                                  <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pval</span><span class="p">]})</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_results</span><span class="p">,</span> <span class="n">df_append</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_results</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_test_modulation_group</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">agg_func</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">plot_mode</span><span class="p">):</span>
    <span class="n">gb_target_phase</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;target_phase&#39;</span><span class="p">)</span>
    <span class="n">target_phases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target_measures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">target_phase</span><span class="p">,</span> <span class="n">df_target_phase</span> <span class="ow">in</span> <span class="n">gb_target_phase</span><span class="p">:</span>
        <span class="n">target_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_phase</span><span class="p">)</span>
        <span class="n">target_measures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_target_phase</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">tval</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">target_measures</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_measures</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">tval_unit</span> <span class="o">=</span> <span class="s1">&#39;ttest_ind&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">permutation_test</span><span class="p">(</span><span class="n">target_measures</span><span class="p">,</span>
                                <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">_dft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">agg_func</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]))[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">permutation_type</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span><span class="p">,</span>
                                <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">,</span>
                                <span class="n">n_resamples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">tval</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">statistic</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">pvalue</span>
        <span class="n">tval_unit</span> <span class="o">=</span> <span class="s1">&#39;dft_amp&#39;</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">target_phases</span><span class="p">[</span><span class="n">ix</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_measures</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">))])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span> <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">target_measures</span><span class="p">)</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">):</span> <span class="n">y</span><span class="p">})</span>
        <span class="n">df_plot_agg</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">)</span> <span class="p">:</span> <span class="n">agg_func</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plot_mode</span> <span class="o">==</span> <span class="s1">&#39;box_strip&#39;</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
                <span class="n">df_plot</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">boxprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">),</span>
                <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span>
                <span class="n">df_plot</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot_mode</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
                <span class="n">df_plot_agg</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">errorbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t = </span><span class="si">{:.3e}</span><span class="s1">, p = </span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">pval</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avgs</span> <span class="o">=</span> <span class="n">df_plot_agg</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">)]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">_dft</span><span class="p">(</span><span class="n">avgs</span><span class="p">,</span> <span class="n">plot_sine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;dft_amp = </span><span class="si">{:.3e}</span><span class="s1">, p = </span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">pval</span><span class="p">))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ps.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;paper&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_modulation_group.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;participant&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">],</span>
                              <span class="s1">&#39;t_unit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tval_unit</span><span class="p">],</span>
                              <span class="s1">&#39;t_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tval</span><span class="p">],</span>
                              <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pval</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">df_results</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_group_mean_psds</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
    <span class="n">stacked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stacked</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">mean</span><span class="p">])</span>

<div class="viewcode-block" id="test_modulation_psd">
<a class="viewcode-back" href="../../clamnibs.html#clamnibs.stats.test_modulation_psd">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_modulation_psd</span><span class="p">(</span>
        <span class="n">df_data</span><span class="p">,</span>
        <span class="n">test_level</span><span class="o">=</span><span class="s1">&#39;participant&#39;</span><span class="p">,</span>
        <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;power&#39;</span><span class="p">,</span>
        <span class="n">freq_lim_tol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot_mode</span><span class="o">=</span><span class="s1">&#39;box_strip&#39;</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test phase-dependent modulation of amplitude, frequency, or aperiodic exponent from power spectral density.</span>

<span class="sd">    This function performs a permutation test to identify phase-dependent modulation</span>
<span class="sd">    of the outcome measure by CLAM-NIBS, and plots the results.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df_data : pandas.DataFrame</span>
<span class="sd">        The DataFrame containing outcome measure per participant, or per epoch</span>
<span class="sd">        for each participant.</span>
<span class="sd">        </span>
<span class="sd">    test_level : str, optional (default=&#39;participant&#39;)</span>
<span class="sd">        The level at which the test should be performed (&#39;participant&#39; or &#39;group&#39;).</span>
<span class="sd">        </span>
<span class="sd">    measure : str, optional (default=&#39;power&#39;)</span>
<span class="sd">        The outcome measure employed (&#39;power&#39;, &#39;frequency&#39;, or &#39;aperiodic&#39;).</span>
<span class="sd">        </span>
<span class="sd">    freq_lim_tol : float, optional (default=0)</span>
<span class="sd">        The tolerance by which assessed peaks in the power spectrum can deviate in </span>
<span class="sd">        frequency from the target frequency range set in the data.</span>
<span class="sd">        </span>
<span class="sd">    plot : str or bool, optional (default=False)</span>
<span class="sd">        If string, the plot(s) will be saved at that path.</span>
<span class="sd">        If True, a figure will be created but not shown or saved.</span>
<span class="sd">        If False, no figure will be created.</span>
<span class="sd">        </span>
<span class="sd">    plot_mode : str, optional (default=&#39;box_strip&#39;)</span>
<span class="sd">        The plotting mode. If all data points should be shown, use &#39;box_strip&#39; for a boxplot and stripplot.</span>
<span class="sd">        If data points should only be visualized as aggregated measures (e.g. accuracy across all trials or </span>
<span class="sd">        variability across all ECG RR intervals), use &#39;bar&#39; for a barplot.</span>

<span class="sd">    Raises:</span>
<span class="sd">    -------</span>
<span class="sd">    Exception:</span>
<span class="sd">        If the test level is not \&#39;participant\&#39; or \&#39;group\&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;ol&#39;</span><span class="p">,</span> <span class="s1">&#39;ns&#39;</span><span class="p">],</span> <span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;target_phase&#39;</span><span class="p">])):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;test_modulation test for phase-dependent modulation, it currently </span><span class="se">\</span>
<span class="s1">                        does not support open-loop or no stimulation conditions&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">measure</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;aperiodic&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Only power, frequency, and aperiodic exponent are supported&#39;</span><span class="p">)</span>
    <span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;psd&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">test_level</span> <span class="o">==</span> <span class="s1">&#39;participant&#39;</span><span class="p">:</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">_test_modulation_participant_psd</span><span class="p">(</span><span class="n">df_data</span><span class="o">=</span><span class="n">df_data</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span> <span class="n">freq_lim_tol</span><span class="o">=</span><span class="n">freq_lim_tol</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_results</span>
    <span class="k">elif</span> <span class="n">test_level</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">_test_modulation_psd_group</span><span class="p">(</span><span class="n">df_data</span><span class="o">=</span><span class="n">df_data</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span> <span class="n">freq_lim_tol</span><span class="o">=</span><span class="n">freq_lim_tol</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_results</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s1">&#39;Test level should be either </span><span class="se">\&#39;</span><span class="s1">participant</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">group</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span></div>

        
<span class="k">def</span><span class="w"> </span><span class="nf">_fooof_agg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">l_freq_target</span><span class="p">,</span> <span class="n">h_freq_target</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">agg_measures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">psd</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">FOOOF</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span><span class="p">)</span>
        <span class="n">freq</span><span class="p">,</span> <span class="nb">pow</span> <span class="o">=</span> <span class="n">get_band_peak_fm</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="p">[</span><span class="n">l_freq_target</span><span class="p">,</span> <span class="n">h_freq_target</span><span class="p">],</span> <span class="n">select_highest</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">aper</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span><span class="o">.</span><span class="n">aperiodic_params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span>
            <span class="n">agg_measures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">pow</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="n">agg_measures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">measure</span> <span class="o">==</span> <span class="s1">&#39;aperiodic&#39;</span><span class="p">:</span>
            <span class="n">agg_measures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aper</span><span class="p">)</span>
            
        <span class="c1"># fm.plot()</span>
        <span class="c1"># plt.axvline(freq, color=&#39;r&#39;, linestyle=&#39;--&#39;)</span>
        <span class="c1"># plt.title(&#39;{:.2f} Hz, {:.2f} a.u.&#39;.format(freq, pow))</span>
        <span class="c1"># plt.show()</span>
            
    <span class="k">return</span> <span class="n">agg_measures</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_fooof_stat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">l_freq_target</span><span class="p">,</span> <span class="n">h_freq_target</span><span class="p">,</span> <span class="n">stat</span><span class="p">):</span>
    <span class="n">agg_measures</span> <span class="o">=</span> <span class="n">_fooof_agg</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">l_freq_target</span><span class="p">,</span> <span class="n">h_freq_target</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;ttest&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">agg_measures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">agg_measures</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="s1">&#39;dft&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_dft</span><span class="p">(</span><span class="n">agg_measures</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_test_modulation_participant_psd</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">freq_lim_tol</span><span class="p">,</span> <span class="n">plot</span><span class="p">):</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">participants</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;participant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">participant</span> <span class="ow">in</span> <span class="n">participants</span><span class="p">:</span>
        <span class="n">df_participant</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="n">df_data</span><span class="p">[</span><span class="s1">&#39;participant&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">participant</span><span class="p">]</span>
        <span class="n">gb_target_phase</span> <span class="o">=</span> <span class="n">df_participant</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;target_phase&#39;</span><span class="p">)</span>
        <span class="n">target_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_psds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target_phase</span><span class="p">,</span> <span class="n">df_target_phase</span> <span class="ow">in</span> <span class="n">gb_target_phase</span><span class="p">:</span>
            <span class="n">target_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_phase</span><span class="p">)</span>
            <span class="n">target_psds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_target_phase</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;ttest&#39;</span>
            <span class="n">alternative</span> <span class="o">=</span> <span class="s1">&#39;two-sided&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;dft&#39;</span>
            <span class="n">alternative</span> <span class="o">=</span> <span class="s1">&#39;greater&#39;</span>
        <span class="n">stat_fun</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_fooof_stat</span><span class="p">,</span> 
                           <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span>  
                           <span class="n">freqs</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">],</span> 
                           <span class="n">l_freq_target</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;l_freq_target&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq_lim_tol</span><span class="p">,</span> 
                           <span class="n">h_freq_target</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;h_freq_target&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">freq_lim_tol</span><span class="p">,</span>
                           <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">permutation_test</span><span class="p">(</span><span class="n">target_psds</span><span class="p">,</span>
                                <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">stat_fun</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                <span class="n">permutation_type</span><span class="o">=</span><span class="s1">&#39;independent&#39;</span><span class="p">,</span>
                                <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span>
                                <span class="n">n_resamples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">tval</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">statistic</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">pvalue</span>
        <span class="n">tval_unit</span> <span class="o">=</span> <span class="n">stat</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">target_phases</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span> <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">_fooof_agg</span><span class="p">(</span><span class="n">target_psds</span><span class="p">,</span> 
                           <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span> 
                           <span class="n">freqs</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">],</span> 
                           <span class="n">l_freq_target</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;l_freq_target&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq_lim_tol</span><span class="p">,</span> 
                           <span class="n">h_freq_target</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;h_freq_target&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">freq_lim_tol</span><span class="p">)</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">):</span> <span class="n">y</span><span class="p">})</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
                <span class="n">df_plot</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">errorbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t = </span><span class="si">{:.3e}</span><span class="s1">, p = </span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">pval</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avgs</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">)]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">_dft</span><span class="p">(</span><span class="n">avgs</span><span class="p">,</span> <span class="n">plot_sine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;dft_amp = </span><span class="si">{:.3e}</span><span class="s1">, p = </span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">pval</span><span class="p">))</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ps.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;paper&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_modulation_</span><span class="si">{}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="n">participant</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">df_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;participant&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">participant</span><span class="p">],</span>
                                  <span class="s1">&#39;t_unit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tval_unit</span><span class="p">],</span>
                                  <span class="s1">&#39;t_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tval</span><span class="p">],</span>
                                  <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pval</span><span class="p">]})</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_results</span><span class="p">,</span> <span class="n">df_append</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_results</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_test_modulation_psd_group</span><span class="p">(</span><span class="n">df_data</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">freq_lim_tol</span><span class="p">,</span> <span class="n">plot</span><span class="p">):</span>
    <span class="n">gb_target_phase</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;target_phase&#39;</span><span class="p">)</span>
    <span class="n">target_phases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target_psds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">target_phase</span><span class="p">,</span> <span class="n">df_target_phase</span> <span class="ow">in</span> <span class="n">gb_target_phase</span><span class="p">:</span>
        <span class="n">target_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_phase</span><span class="p">)</span>
        <span class="n">target_psds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_target_phase</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;ttest&#39;</span>
        <span class="n">alternative</span> <span class="o">=</span> <span class="s1">&#39;two-sided&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;dft&#39;</span>
        <span class="n">alternative</span> <span class="o">=</span> <span class="s1">&#39;greater&#39;</span>
    <span class="n">stat_fun</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_fooof_stat</span><span class="p">,</span> 
                        <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span> 
                        <span class="n">freqs</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">],</span> 
                        <span class="n">l_freq_target</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;l_freq_target&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq_lim_tol</span><span class="p">,</span> 
                        <span class="n">h_freq_target</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;h_freq_target&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">freq_lim_tol</span><span class="p">,</span>
                        <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">permutation_test</span><span class="p">(</span><span class="n">target_psds</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="n">stat_fun</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                            <span class="n">permutation_type</span><span class="o">=</span><span class="s1">&#39;independent&#39;</span><span class="p">,</span>
                            <span class="n">alternative</span><span class="o">=</span><span class="n">alternative</span><span class="p">,</span>
                            <span class="n">n_resamples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">tval</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">statistic</span>
    <span class="n">pval</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">pvalue</span>
    <span class="n">tval_unit</span> <span class="o">=</span> <span class="n">stat</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">target_phases</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span> <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">_fooof_agg</span><span class="p">(</span><span class="n">target_psds</span><span class="p">,</span> 
                        <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">,</span> 
                        <span class="n">freqs</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">],</span> 
                        <span class="n">l_freq_target</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;l_freq_target&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq_lim_tol</span><span class="p">,</span> 
                        <span class="n">h_freq_target</span><span class="o">=</span><span class="n">df_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;h_freq_target&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">freq_lim_tol</span><span class="p">)</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">):</span> <span class="n">y</span><span class="p">})</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
            <span class="n">df_plot</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Target Phase (°)&#39;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">errorbar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t = </span><span class="si">{:.3e}</span><span class="s1">, p = </span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">pval</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avgs</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">)]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">_dft</span><span class="p">(</span><span class="n">avgs</span><span class="p">,</span> <span class="n">plot_sine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;dft_amp = </span><span class="si">{:.3e}</span><span class="s1">, p = </span><span class="si">{:.3e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tval</span><span class="p">,</span> <span class="n">pval</span><span class="p">))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;ps.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;paper&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_modulation_group.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measure</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;participant&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">],</span>
                              <span class="s1">&#39;t_unit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tval_unit</span><span class="p">],</span>
                              <span class="s1">&#39;t_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">tval</span><span class="p">],</span>
                              <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pval</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">df_results</span>

<div class="viewcode-block" id="get_network_modulation_amp_phase">
<a class="viewcode-back" href="../../clamnibs.html#clamnibs.stats.get_network_modulation_amp_phase">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_network_modulation_amp_phase</span><span class="p">(</span><span class="n">df_network_results</span><span class="p">,</span> <span class="n">df_network_data</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get amplitude (depth) and optimal phase of modulation of connectivity</span>
<span class="sd">    in a network.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    df_network_results: pandas.DataFrame</span>
<span class="sd">        The dataframe containing the connections which were modulated at the </span>
<span class="sd">        participant- or group-level.</span>
<span class="sd">        </span>
<span class="sd">    df_network_data: pandas.DataFrame</span>
<span class="sd">        The dataframe containing the connectivity matrix for each trial </span>
<span class="sd">        and participant.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">participants</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_network_data</span><span class="p">[</span><span class="s1">&#39;participant&#39;</span><span class="p">])</span>
    <span class="n">measure</span> <span class="o">=</span> <span class="n">df_network_data</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">participant</span> <span class="ow">in</span> <span class="n">participants</span><span class="p">:</span>
        <span class="n">df_network_data_participant</span> <span class="o">=</span> <span class="n">df_network_data</span><span class="p">[</span><span class="n">df_network_data</span><span class="p">[</span><span class="s1">&#39;participant&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">participant</span><span class="p">]</span>
        <span class="n">df_network_results_participant</span> <span class="o">=</span> <span class="n">df_network_results</span><span class="p">[</span><span class="n">df_network_results</span><span class="p">[</span><span class="s1">&#39;participant&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">participant</span><span class="p">]</span>
        
        <span class="n">network_data_participant</span><span class="p">,</span> <span class="n">target_phases</span> <span class="o">=</span> <span class="n">df_to_array</span><span class="p">(</span><span class="n">df_network_data_participant</span><span class="p">)</span>
        <span class="c1"># this is now (n_phases, n_epochs, n_chs, n_chs)</span>
        
        <span class="k">for</span> <span class="n">ix_cluster</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">df_network_results_participant</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            
            <span class="n">t_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;t_values&#39;</span><span class="p">])</span>  <span class="c1"># average over t-values per connection in cluster</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span>            <span class="c1"># this is one p-value for the cluster</span>
            <span class="n">ixs_row</span><span class="p">,</span> <span class="n">ixs_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cluster</span><span class="p">[</span><span class="s1">&#39;connections&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>    <span class="c1"># this contains the indices marking connections between sensors in cluster</span>
            <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">network_data_participant</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ixs_row</span><span class="p">,</span> <span class="n">ixs_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">avgs</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">amp</span><span class="p">,</span> <span class="n">phase</span> <span class="o">=</span> <span class="n">_dft</span><span class="p">(</span><span class="n">avgs</span><span class="p">)</span>
            <span class="n">df_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;participant&#39;</span><span class="p">:[</span><span class="n">participant</span><span class="p">],</span>
                                      <span class="s1">&#39;measure&#39;</span><span class="p">:[</span><span class="n">measure</span><span class="p">],</span>
                                      <span class="s1">&#39;cluster&#39;</span><span class="p">:[</span><span class="n">ix_cluster</span><span class="p">],</span>
                                      <span class="s1">&#39;amplitude_raw&#39;</span><span class="p">:[</span><span class="n">amp</span><span class="p">],</span>
                                      <span class="s1">&#39;amplitude_perc&#39;</span><span class="p">:[</span><span class="mi">2</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="n">amp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avgs</span><span class="p">)],</span>
                                      <span class="s1">&#39;phase_rad&#39;</span><span class="p">:[</span><span class="n">phase</span><span class="p">],</span>
                                      <span class="s1">&#39;phase_deg&#39;</span><span class="p">:[</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">phase</span><span class="p">))]})</span>
            <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_results</span><span class="p">,</span> <span class="n">df_append</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_results</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CLAM-NIBS</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">clamnibs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../clamnibs.html">clamnibs package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, David Haslacher.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>